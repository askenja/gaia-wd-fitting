# Alex Golovin code from https://github.com/AlexGolovin/gaiaedr3_g_rp_synthetic/blob/main/g_rp_synth_deblending.py

import numpy as np
from astropy.table import Table
from scipy import interpolate
import warnings

# Model parameters:
# (Stores knots, coefficients, and the degree of the spline)

_tck = (([0.04323864, 0.04323864, 0.04323864, 0.04323864, 0.14323864,
       0.15045376, 0.15766887, 0.16488399, 0.17209911, 0.17931422,
       0.18652934, 0.19374446, 0.20095957, 0.20817469, 0.2153898 ,
       0.22260492, 0.22982004, 0.23703515, 0.24425027, 0.25146539,
       0.2586805 , 0.26589562, 0.27311074, 0.28032585, 0.28754097,
       0.29475609, 0.3019712 , 0.30918632, 0.31640144, 0.32361655,
       0.33083167, 0.33804679, 0.3452619 , 0.35247702, 0.35969213,
       0.36690725, 0.37412237, 0.38133748, 0.3885526 , 0.39576772,
       0.40298283, 0.41019795, 0.41741307, 0.42462818, 0.4318433 ,
       0.43905842, 0.44627353, 0.45348865, 0.46070377, 0.46791888,
       0.475134  , 0.48234912, 0.48956423, 0.49677935, 0.50399446,
       0.51120958, 0.5184247 , 0.52563981, 0.53285493, 0.54007005,
       0.54728516, 0.55450028, 0.5617154 , 0.56893051, 0.57614563,
       0.58336075, 0.59057586, 0.59779098, 0.6050061 , 0.61222121,
       0.61943633, 0.62665145, 0.63386656, 0.64108168, 0.64829679,
       0.65551191, 0.66272703, 0.66994214, 0.67715726, 0.68437238,
       0.69158749, 0.69880261, 0.70601773, 0.71323284, 0.72044796,
       0.72766308, 0.73487819, 0.74209331, 0.74930843, 0.75652354,
       0.76373866, 0.77095378, 0.77816889, 0.78538401, 0.79259912,
       0.79981424, 0.80702936, 0.81424447, 0.82145959, 0.82867471,
       0.83588982, 0.84310494, 0.85032006, 0.85753517, 0.86475029,
       0.87196541, 0.87918052, 0.88639564, 0.89361076, 0.90082587,
       0.90804099, 0.91525611, 0.92247122, 0.92968634, 0.93690145,
       0.94411657, 0.95133169, 0.9585468 , 0.96576192, 0.97297704,
       0.98019215, 0.98740727, 0.99462239, 1.0018375 , 1.00905262,
       1.01626774, 1.02348285, 1.03069797, 1.03791309, 1.0451282 ,
       1.05234332, 1.05955843, 1.06677355, 1.07398867, 1.08120378,
       1.0884189 , 1.09563402, 1.10284913, 1.11006425, 1.11727937,
       1.12449448, 1.1317096 , 1.13892472, 1.14613983, 1.15335495,
       1.16057007, 1.16778518, 1.1750003 , 1.18221542, 1.18943053,
       1.19664565, 1.20386076, 1.21107588, 1.218291  , 1.22550611,
       1.23272123, 1.23993635, 1.24715146, 1.25436658, 1.2615817 ,
       1.26879681, 1.27601193, 1.28322705, 1.29044216, 1.29765728,
       1.3048724 , 1.31208751, 1.31930263, 1.32651775, 1.33373286,
       1.34094798, 1.34816309, 1.35537821, 1.36259333, 1.36980844,
       1.37702356, 1.38423868, 1.39145379, 1.39866891, 1.40588403,
       1.41309914, 1.42031426, 1.42752938, 1.43474449, 1.44195961,
       1.44917473, 1.45638984, 1.46360496, 1.47082008, 1.47803519,
       1.48525031, 1.49246542, 1.49968054, 1.50689566, 1.51411077,
       1.52132589, 1.52854101, 1.53575612, 1.54297124, 1.55018636,
       1.55740147, 1.56461659, 1.57183171, 1.57904682, 1.58626194,
       1.59347706, 1.60069217, 1.60790729, 1.61512241, 1.62233752,
       1.62955264, 1.63676775, 1.64398287, 1.65119799, 1.6584131 ,
       1.66562822, 1.67284334, 1.68005845, 1.68727357, 1.69448869,
       1.7017038 , 1.70891892, 1.71613404, 1.72334915, 1.73056427,
       1.73777939, 1.7449945 , 1.75220962, 1.75942474, 1.76663985,
       1.77385497, 1.78107008, 1.7882852 , 1.79550032, 1.80271543,
       1.80993055, 1.81714567, 1.82436078, 1.8315759 , 1.83879102,
       1.84600613, 1.85322125, 1.86043637, 1.86765148, 1.8748666 ,
       1.88208172, 1.88929683, 1.89651195, 1.90372707, 1.91094218,
       1.9181573 , 1.92537241, 1.93258753, 1.93980265, 1.94701776,
       1.95423288, 1.961448  , 1.96866311, 1.97587823, 1.98309335,
       1.99030846, 1.99752358, 2.0047387 , 2.01195381, 2.01916893,
       2.02638405, 2.03359916, 2.04081428, 2.0480294 , 2.05524451,
       2.06245963, 2.06967474, 2.07688986, 2.08410498, 2.09132009,
       2.09853521, 2.10575033, 2.11296544, 2.12018056, 2.12739568,
       2.13461079, 2.14182591, 2.14904103, 2.15625614, 2.16347126,
       2.17068638, 2.17790149, 2.18511661, 2.19233172, 2.19954684,
       2.20676196, 2.21397707, 2.22119219, 2.22840731, 2.23562242,
       2.24283754, 2.25005266, 2.25726777, 2.26448289, 2.27169801,
       2.27891312, 2.28612824, 2.29334336, 2.30055847, 2.30777359,
       2.31498871, 2.32220382, 2.32941894, 2.33663405, 2.34384917,
       2.35106429, 2.3582794 , 2.36549452, 2.37270964, 2.37992475,
       2.38713987, 2.39435499, 2.4015701 , 2.40878522, 2.41600034,
       2.42321545, 2.43043057, 2.43764569, 2.4448608 , 2.45207592,
       2.45929104, 2.46650615, 2.47372127, 2.48093638, 2.4881515 ,
       2.49536662, 2.50258173, 2.50979685, 2.51701197, 2.52422708,
       2.5314422 , 2.53865732, 2.54587243, 2.55308755, 2.56030267,
       2.56751778, 2.5747329 , 2.58194802, 2.58916313, 2.59637825,
       2.60359337, 2.61080848, 2.6180236 , 2.62523871, 2.63245383,
       2.63966895, 2.64688406, 2.65409918, 2.6613143 , 2.66852941,
       2.67574453, 2.68295965, 2.69017476, 2.69738988, 2.704605  ,
       2.71182011, 2.71903523, 2.72625035, 2.73346546, 2.74068058,
       2.7478957 , 2.75511081, 2.76232593, 2.76954104, 2.77675616,
       2.78397128, 2.79118639, 2.79840151, 2.80561663, 2.81283174,
       2.82004686, 2.82726198, 2.83447709, 2.84169221, 2.84890733,
       2.85612244, 2.86333756, 2.87055268, 2.87776779, 2.88498291,
       2.89219803, 2.89941314, 2.90662826, 2.91384337, 2.92105849,
       2.92827361, 2.93548872, 2.94270384, 2.94991896, 2.95713407,
       2.96434919, 2.97156431, 2.97877942, 2.98599454, 2.99320966,
       3.00042477, 3.00763989, 3.01485501, 3.02207012, 3.02928524,
       3.03650036, 3.04371547, 3.05093059, 3.0581457 , 3.06536082,
       3.07257594, 3.07979105, 3.08700617, 3.09422129, 3.1014364 ,
       3.10865152, 3.11586664, 3.12308175, 3.13029687, 3.13751199,
       3.1447271 , 3.15194222, 3.15915734, 3.16637245, 3.17358757,
       3.18080269, 3.1880178 , 3.19523292, 3.20244803, 3.20966315,
       3.21687827, 3.22409338, 3.2313085 , 3.23852362, 3.24573873,
       3.25295385, 3.26016897, 3.26738408, 3.2745992 , 3.28181432,
       3.28902943, 3.29624455, 3.30345967, 3.31067478, 3.3178899 ,
       3.32510502, 3.33232013, 3.33953525, 3.34675036, 3.35396548,
       3.3611806 , 3.36839571, 3.37561083, 3.38282595, 3.39004106,
       3.39725618, 3.4044713 , 3.41168641, 3.41890153, 3.42611665,
       3.43333176, 3.44054688, 3.447762  , 3.45497711, 3.46219223,
       3.46940734, 3.47662246, 3.48383758, 3.49105269, 3.49826781,
       3.50548293, 3.51269804, 3.51991316, 3.52712828, 3.53434339,
       3.54155851, 3.54877363, 3.55598874, 3.56320386, 3.57041898,
       3.57763409, 3.58484921, 3.59206433, 3.59927944, 3.60649456,
       3.61370967, 3.62092479, 3.62813991, 3.63535502, 3.64257014,
       3.64978526, 3.65700037, 3.66421549, 3.67143061, 3.67864572,
       3.68586084, 3.69307596, 3.70029107, 3.70750619, 3.71472131,
       3.72193642, 3.72915154, 3.73636666, 3.74358177, 4.24358177,
       4.24358177, 4.24358177, 4.24358177]), 
       ([0.0385512 , 0.06229951, 0.07822452, 0.11073688, 0.11066262,
       0.11708422, 0.12103918, 0.12602898, 0.13023361, 0.13456073,
       0.13710696, 0.14528391, 0.14771979, 0.15473338, 0.15469625,
       0.16454264, 0.16739917, 0.17082587, 0.17726988, 0.17934299,
       0.18584206, 0.18895789, 0.19312445, 0.19793133, 0.20281668,
       0.20867815, 0.21132699, 0.21743066, 0.2188794 , 0.22832188,
       0.22834494, 0.23337111, 0.2396018 , 0.2424417 , 0.24680369,
       0.25116417, 0.25660816, 0.26015538, 0.26528032, 0.26889459,
       0.27383341, 0.27929065, 0.28280788, 0.28606376, 0.29151159,
       0.29378077, 0.30013358, 0.30394825, 0.30845086, 0.3120294 ,
       0.31687995, 0.32093119, 0.32477105, 0.32946897, 0.33351548,
       0.3372118 , 0.34224028, 0.34555024, 0.35019571, 0.35375061,
       0.35880478, 0.36192021, 0.3666223 , 0.37069664, 0.37436571,
       0.37888521, 0.38260835, 0.38709201, 0.39066286, 0.39499573,
       0.39884845, 0.40261862, 0.40654376, 0.41056799, 0.41453122,
       0.4179561 , 0.42265704, 0.4255719 , 0.43020889, 0.43326278,
       0.43751837, 0.4412439 , 0.44500982, 0.44907691, 0.45216888,
       0.45619527, 0.46020203, 0.46365107, 0.46734999, 0.47091432,
       0.47493765, 0.47847131, 0.48218734, 0.48551496, 0.49007335,
       0.49272347, 0.49702766, 0.50024089, 0.50362821, 0.50778262,
       0.51061897, 0.51477461, 0.51771861, 0.52177345, 0.52508575,
       0.52866838, 0.53230678, 0.53540793, 0.53924607, 0.54254585,
       0.54634084, 0.54992528, 0.55349837, 0.55679349, 0.56035724,
       0.56395646, 0.56722125, 0.57122911, 0.5741375 , 0.57805525,
       0.58112382, 0.58487761, 0.58819013, 0.59129247, 0.59521542,
       0.59777522, 0.60194811, 0.60567754, 0.60892656, 0.61210108,
       0.61524842, 0.6195786 , 0.62204063, 0.62616348, 0.62912293,
       0.63289238, 0.63664236, 0.63975526, 0.64266383, 0.64682384,
       0.64916385, 0.65353523, 0.65551836, 0.65915359, 0.66232436,
       0.66631098, 0.66906666, 0.67225034, 0.67515843, 0.67856381,
       0.68180803, 0.68503033, 0.68840423, 0.69151046, 0.69420353,
       0.69760838, 0.7010196 , 0.70382898, 0.70747032, 0.71004363,
       0.71396021, 0.71650373, 0.71991059, 0.72268161, 0.7258421 ,
       0.72903704, 0.73209807, 0.73529694, 0.73802008, 0.741701  ,
       0.7447373 , 0.74740911, 0.75029307, 0.75430589, 0.75667343,
       0.7603833 , 0.76279167, 0.76609721, 0.76861753, 0.77207705,
       0.77508489, 0.77765577, 0.78115045, 0.78403892, 0.78682475,
       0.79037859, 0.79233007, 0.796194  , 0.79838116, 0.80205815,
       0.80479045, 0.80749522, 0.81037114, 0.81372714, 0.81662807,
       0.81906513, 0.82268183, 0.8251075 , 0.82829826, 0.83118771,
       0.83374823, 0.83697672, 0.83929264, 0.84263627, 0.84536873,
       0.84859106, 0.8507028 , 0.85399091, 0.85661697, 0.85965555,
       0.862323  , 0.86569157, 0.86776208, 0.87127901, 0.87333299,
       0.8767668 , 0.87924606, 0.88187052, 0.88524128, 0.88712102,
       0.89071427, 0.89304657, 0.89622478, 0.89870556, 0.90153598,
       0.9043635 , 0.90728018, 0.90984112, 0.91243701, 0.91526541,
       0.91809785, 0.92042893, 0.92352462, 0.92591718, 0.92909308,
       0.93154119, 0.93461613, 0.93662478, 0.94003919, 0.94237847,
       0.94529031, 0.94753666, 0.95043515, 0.95276442, 0.95579802,
       0.95849749, 0.96086159, 0.96362089, 0.96606621, 0.96874416,
       0.9713739 , 0.97381749, 0.9767915 , 0.97892372, 0.98167117,
       0.9838949 , 0.98680224, 0.98944199, 0.99180509, 0.99420885,
       0.99678354, 0.99926517, 1.00178263, 1.00455584, 1.00727404,
       1.00890194, 1.01197671, 1.0140329 , 1.01624028, 1.01903911,
       1.02107552, 1.02404776, 1.02623024, 1.02881637, 1.03068949,
       1.03325238, 1.03566962, 1.03781694, 1.04075858, 1.04273723,
       1.04488462, 1.04732103, 1.04961745, 1.05153484, 1.05427705,
       1.05637741, 1.05877545, 1.0606754 , 1.06327266, 1.06533053,
       1.06778078, 1.06985829, 1.0719824 , 1.07438514, 1.07628089,
       1.07871038, 1.08061267, 1.08275577, 1.08529657, 1.08668338,
       1.08933725, 1.0913161 , 1.09360567, 1.09565397, 1.09730296,
       1.09992529, 1.10161089, 1.10370607, 1.10585083, 1.10753337,
       1.11025476, 1.11164392, 1.11396636, 1.11603866, 1.11788353,
       1.11979047, 1.12182849, 1.1238607 , 1.12572677, 1.12764102,
       1.12984201, 1.1316551 , 1.13325916, 1.13562131, 1.13706563,
       1.13904958, 1.1409143 , 1.14303695, 1.1450187 , 1.1467518 ,
       1.14842592, 1.1505577 , 1.1523463 , 1.15387865, 1.15583413,
       1.15747425, 1.15935537, 1.16132528, 1.16308184, 1.16508678,
       1.16630545, 1.1688336 , 1.17002383, 1.17208901, 1.17340923,
       1.17579037, 1.1770062 , 1.17909675, 1.1807183 , 1.18246078,
       1.18416997, 1.18587002, 1.18749566, 1.18918251, 1.19088381,
       1.19291577, 1.19431858, 1.19615588, 1.19759062, 1.19907783,
       1.20121029, 1.20222821, 1.20453034, 1.2054394 , 1.20774082,
       1.20875126, 1.21090364, 1.21219635, 1.21362928, 1.21580169,
       1.21729053, 1.21861802, 1.21999531, 1.2221757 , 1.22347207,
       1.22473736, 1.22653702, 1.22797554, 1.22944551, 1.23112381,
       1.2329467 , 1.23394802, 1.23579224, 1.23729658, 1.23842914,
       1.24052414, 1.24152451, 1.24348521, 1.24491617, 1.24628345,
       1.24716891, 1.249421  , 1.25024576, 1.25202751, 1.25371556,
       1.25410712, 1.25678466, 1.25733778, 1.25911532, 1.26078354,
       1.26182934, 1.26362565, 1.26440019, 1.26655563, 1.2680222 ,
       1.26934068, 1.27137275, 1.27174648, 1.27371905, 1.27506916,
       1.27687514, 1.27847602, 1.27956452, 1.28008995, 1.28282285,
       1.2832058 , 1.28528006, 1.28652311, 1.28774323, 1.28980882,
       1.28987247, 1.2929    , 1.29282141, 1.29560147, 1.29644844,
       1.29735942, 1.2988278 , 1.3001301 , 1.30147524, 1.30287144,
       1.30477874, 1.30561521, 1.30675115, 1.30884207, 1.30915439,
       1.31089913, 1.31326122, 1.31257923, 1.31498834, 1.31607371,
       1.31744007, 1.31968496, 1.32018532, 1.3216473 , 1.32116226,
       1.32575137, 1.32458845, 1.32585761, 1.32857354, 1.32771728,
       1.32959414, 1.33145187, 1.3323148 , 1.33410029, 1.33547481,
       1.33486439, 1.33763362, 1.3386783 , 1.33868231, 1.34346693,
       1.34134982, 1.34483973, 1.34277232, 1.34675019, 1.34692682,
       1.34909908, 1.35031132, 1.35030442, 1.35139971, 1.35387519,
       1.35300107, 1.35791171, 1.35429206, 1.35812396, 1.35704537,
       1.36211966, 1.36092773, 1.36048455, 1.36578409, 1.36391182,
       1.36743243, 1.36945721, 1.36533669, 1.37205237, 1.3703583 ,
       1.37196119, 1.36967377, 1.37427163, 1.37722886, 1.37519636,
       1.37962284, 1.37666315, 1.3766371 , 1.38138777, 1.38692556,
       1.38314558, 1.38233694, 1.38562515, 1.38661001, 1.38469021,
       1.38809177, 1.41569175, 1.43010002, 1.45578429, 0.        ,
       0.        , 0.        , 0.        ]), 3)



def g_rp_synth(bp_rp):
    """
    Calculates synthetic (or "deblended") G-RP for datasets from Gaia eDR3 using BP-RP photometry as input observable. The details of this method are described in Golovin et al. 2021, A&A, [...].
    
    Input:
    BP-RP value (or an array of values). 
    Note! BP-RP array needs to be in strictly increasing order.
    
    Applicability range: 
    0.0 < BP-RP < 4.25
    Note! It is recommended to use the values which have bp_mean_flux_over_error > 20 and rp_mean_flux_over_error > 20 for optimum results.

    Acknowledgement: 
    if your paper uses results obtained with this code, please cite Golovin et al. 2021, A&A, [...] [URL pending].
    """
    
    # Flag to check if BP-RP is not in increasing order
    if (any(((bp_rp[i] > bp_rp[i + 1]) & ~np.isnan(bp_rp[i]) & ~np.isnan(bp_rp[i+1])) for i in range(len(bp_rp)-1))):
        warnings.warn('The input argument - BP-RP color - is not sorted, the program may not give accuarate results.',Warning)
    
    
    # Create a new BP-RP list for the applicability range 0<BP-RP<4.25
    bp_rp_in_range = np.empty(len(bp_rp))
    bp_rp_in_range[:] = np.nan
    
    for index, color in enumerate(bp_rp):
        if ((color > 0.0) & (color<4.25)):
            bp_rp_in_range[index] = color
            
    synth_val = interpolate.splev(bp_rp_in_range, _tck, der=0, ext=0)
    
    return synth_val


